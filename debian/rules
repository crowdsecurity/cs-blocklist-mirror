#!/usr/bin/make -f

export DEB_VERSION=$(shell dpkg-parsechangelog | grep -E '^Version:' | cut -f 2 -d ' ')
export BUILD_VERSION=v${DEB_VERSION}-debian-pragmatic

%:
	dh $@

override_dh_systemd_start:
	echo "Not running dh_systemd_start"
override_dh_auto_clean:
override_dh_auto_test:
override_dh_auto_build:
override_dh_auto_install:
	make

	BOUNCER=crowdsec-blocklist-mirror; \
	PKG="$$BOUNCER"; \
	mkdir -p "debian/$$PKG/var/lib/crowdsec/$$BOUNCER/cache/"; \
	install -D -m 0755 "$$BOUNCER" -t "debian/$$PKG/usr/bin/"; \
	install -D -m 0600 "scripts/_bouncer.sh" -t "debian/$$PKG/usr/lib/$$PKG/"; \
	install -D -m 0600 "config/$$BOUNCER.yaml" "debian/$$PKG/etc/crowdsec/bouncers/$$BOUNCER.yaml"; \
	BIN="/usr/bin/$$BOUNCER" CFG="/etc/crowdsec/bouncers" envsubst '$$BIN $$CFG' < "config/$$BOUNCER.service" | install -D -m 0644 /dev/stdin "debian/$$PKG/etc/systemd/system/$$BOUNCER.service"
